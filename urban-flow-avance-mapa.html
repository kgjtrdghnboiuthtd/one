<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Urban Flow — Estado de Avance & Mapa Operativo (Lima)</title>
  <meta name="description" content="Dashboard institucional: avance del proyecto + mapa de tráfico (OSM) con compatibilidad Google Maps y opción Waze for Cities." />
  <link rel="preconnect" href="https://tile.openstreetmap.org" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#0b1020;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --line:rgba(255,255,255,.14);
      --card:rgba(255,255,255,.05);
      --card2:rgba(255,255,255,.07);
      --shadow: 0 22px 70px rgba(0,0,0,.45);
      --radius: 18px;
      --accent:#67e8f9;
      --accent2:#a78bfa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(103,232,249,.16), transparent 55%),
        radial-gradient(900px 600px at 85% 30%, rgba(167,139,250,.16), transparent 55%),
        linear-gradient(180deg, #070a14 0%, #0b1020 45%, #070a14 100%);
      overflow-x:hidden;
    }
    a{color:inherit}
    .nav{
      position:sticky;top:0;z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(7,10,20,.80), rgba(7,10,20,.42));
      border-bottom:1px solid var(--line);
    }
    .nav-inner{
      max-width:1280px;margin:0 auto;
      padding:10px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, rgba(103,232,249,.95), rgba(167,139,250,.95));
      box-shadow: 0 12px 26px rgba(103,232,249,.14);
      position:relative;overflow:hidden;
    }
    .logo:after{
      content:"";position:absolute;inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 45%);
      transform: rotate(12deg);
      animation: drift 8s ease-in-out infinite;
      opacity:.55;
    }
    @keyframes drift{
      0%,100%{transform:translate(0,0) rotate(12deg)}
      50%{transform:translate(14px,-10px) rotate(12deg)}
    }
    .brand h1{margin:0;font-size:13px;letter-spacing:.25px;color:var(--muted);font-weight:750}
    .nav-links{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .nav-links a{
      text-decoration:none;
      padding:8px 10px;border-radius:999px;
      border:1px solid transparent;
      color:var(--muted);
      transition:.18s ease;
      font-size:12px;
    }
    .nav-links a:hover{border-color:var(--line);color:var(--text);background:rgba(255,255,255,.04)}

    .wrap{max-width:1280px;margin:0 auto;padding:18px 16px 70px}
    .top{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:stretch;
      margin-top:14px;
    }
    @media(max-width:1020px){.top{grid-template-columns:1fr}}
    .panel{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .panel:before{
      content:"";position:absolute;inset:-1px;
      background: radial-gradient(800px 220px at 20% 0%, rgba(103,232,249,.14), transparent 55%),
                  radial-gradient(800px 220px at 80% 0%, rgba(167,139,250,.12), transparent 55%);
      pointer-events:none;
      opacity:.85;
    }
    .panel > *{position:relative}

    .kicker{
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap
    }
    .kicker .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
    }
    .kicker .tag b{color:var(--text)}
    .title{margin:10px 0 0;font-size:18px;letter-spacing:-.2px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:12.8px;line-height:1.55}

    .grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:12px;
      margin-top:12px;
    }
    .card{
      grid-column:span 4;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
    }
    @media(max-width:1020px){.card{grid-column:span 12}}
    .card h3{margin:0;font-size:12.8px}
    .card p{margin:6px 0 0;color:var(--muted);font-size:12.3px;line-height:1.55}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .rightcol{display:grid;gap:12px}
    .mini{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius: var(--radius);
      padding:14px;
    }
    .mini h3{margin:0 0 8px;font-size:13px}
    .mini .small{color:var(--muted);font-size:12.3px;line-height:1.55;margin:0}
    .sep{height:1px;background:var(--line);margin:12px 0}

    .mid{
      display:grid;
      grid-template-columns: 1.55fr .45fr;
      gap:14px;
      margin-top:14px;
      align-items:stretch;
    }
    @media(max-width:1020px){.mid{grid-template-columns:1fr}}
    #map{
      width:100%;
      height:560px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:#0a0f1f;
    }
    @media(max-width:620px){#map{height:520px}}

    .controls{display:grid;gap:10px}
    .control{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
    }
    .control h4{margin:0 0 10px;font-size:12.8px;color:var(--text)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
    .row label{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:12.3px;cursor:pointer}
    .toggle{
      appearance:none;
      width:44px;height:26px;border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      position:relative;
      outline:none;
      cursor:pointer;
      transition:.18s ease;
    }
    .toggle:after{
      content:"";
      position:absolute;top:50%;left:4px;
      width:18px;height:18px;border-radius:50%;
      transform:translateY(-50%);
      background:rgba(255,255,255,.88);
      transition:.18s ease;
    }
    .toggle:checked{
      background:rgba(103,232,249,.25);
      border-color:rgba(103,232,249,.45);
    }
    .toggle:checked:after{left:22px;background:#071022}

    .btn{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:var(--text);
      text-decoration:none;
      font-weight:800;
      font-size:12.5px;
      transition:.18s ease;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
    .btn.primary{
      border-color:transparent;
      background: linear-gradient(135deg, rgba(103,232,249,.95), rgba(167,139,250,.95));
      color:#071022;
    }
    .btn.ghost{
      background:rgba(255,255,255,.03);
    }

    .section-title{
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
      margin:18px 0 10px;
    }
    .section-title h2{margin:0;font-size:16px;letter-spacing:-.2px}
    .section-title span{color:var(--muted);font-size:12.2px}

    .list{margin:0;padding:0;list-style:none;display:grid;gap:10px}
    .li{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
    }
    .li b{display:block;font-size:12.8px;margin-bottom:2px}
    .li div{color:var(--muted);font-size:12.3px;line-height:1.55}

    .footer{
      margin-top:18px;
      color:var(--muted);
      font-size:12.2px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .notice{color:var(--muted);font-size:12.2px;line-height:1.55;margin:0}
    .em{color:rgba(255,255,255,.86);font-weight:800}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* Timeline */
    .timeline{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
      margin-top:12px;
    }
    .t-top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .t-top .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .t-top .stamp{color:var(--muted);font-size:12.2px}
    .slider{
      width:100%;
      margin-top:10px;
      accent-color: var(--accent);
    }

    /* Big benefit cards */
    .benefit-grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:12px;
      margin-top:12px;
    }
    .benefit{
      grid-column:span 6;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: 20px;
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    @media(max-width:1020px){.benefit{grid-column:span 12}}
    .benefit:before{
      content:"";
      position:absolute;inset:-1px;
      background:
        radial-gradient(700px 220px at 15% 0%, rgba(103,232,249,.14), transparent 55%),
        radial-gradient(700px 220px at 85% 0%, rgba(167,139,250,.12), transparent 55%);
      opacity:.9;
      pointer-events:none;
    }
    .benefit > *{position:relative}
    .b-head{display:flex;gap:12px;align-items:flex-start}
    .icon{
      width:42px;height:42px;border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
    }
    .b-title{margin:0;font-size:14px;letter-spacing:-.2px}
    .b-sub{margin:6px 0 0;color:var(--muted);font-size:12.6px;line-height:1.55}
    .b-metrics{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .metric{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px 12px;
      min-width: 160px;
    }
    .metric .n{font-size:16px;font-weight:900;letter-spacing:-.2px}
    .metric .l{margin-top:4px;color:var(--muted);font-size:12.2px}
    .hint{margin-top:10px;color:var(--muted);font-size:12.2px}
  </style>
</head>

<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Urban Flow · Estado de avance & mapa operativo — Lima</h1>
      </div>
      <div class="nav-links">
        <a href="#mapa">Mapa</a>
        <a href="#avance">Avance</a>
        <a href="#waze">Waze</a>
        <a href="#ciudades">Ciudades + resultados</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- TOP: Estado -->
    <div class="top">
      <div class="panel" id="avance">
        <div class="kicker">
          <span class="tag"><b>Fase</b>: Datos → Simulación → Piloto supervisado</span>
          <span class="tag"><b>Uso</b>: interno (reunión institucional)</span>
        </div>
        <div class="title">Estado de avance (visión ejecutiva)</div>
        <p class="sub">
          Tablero con mapa operativo (OSM) + capas de congestión “snap to road” (OSRM) y una <span class="em">timeline</span>
          para visualizar el histórico (base para entrenar/calibrar modelos).
        </p>

        <div class="grid">
          <div class="card">
            <span class="pill"><span class="dot ok"></span> Módulo 1: Datos</span>
            <h3 style="margin-top:10px">Ingesta & normalización</h3>
            <p>Modelo de datos listo para incidentes, cierres y velocidad agregada (por proveedor autorizado).</p>
          </div>
          <div class="card">
            <span class="pill"><span class="dot warn"></span> Módulo 2: Simulación</span>
            <h3 style="margin-top:10px">Gemelo digital (piloto)</h3>
            <p>Requiere definir distrito/corredor y fuentes oficiales para calibrar escenarios (baseline → simulación).</p>
          </div>
          <div class="card">
            <span class="pill"><span class="dot warn"></span> Módulo 3: Piloto</span>
            <h3 style="margin-top:10px">Emergencias (onda verde)</h3>
            <p>Diseño “supervisado + fail-safe”. Necesita validación operativa y marco de seguridad.</p>
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid">
          <div class="card" style="grid-column:span 6">
            <h3>Fuentes de datos (previstas)</h3>
            <p>
              • OpenStreetMap (base cartográfica) ·
              • Feeds institucionales (cierres/obras/eventos) ·
              • Velocidades agregadas (si se habilita proveedor) ·
              • Waze for Cities (si hay autorización).
            </p>
          </div>
          <div class="card" style="grid-column:span 6">
            <h3>Gobernanza / seguridad</h3>
            <p>
              Enfoque recomendado: asistencia a decisión + simulación antes de intervenir semáforos.
              Logs, auditoría y reversión a plan estándar como requisito.
            </p>
          </div>
        </div>

        <div class="sep"></div>

        <p class="notice">
          <span class="em">Nota técnica:</span> la capa “congestión” se genera como geometría de ruta real (snap-to-road) usando OSRM.
          Si OSRM no está disponible, cae en modo fallback (líneas simples).
        </p>
      </div>

      <div class="rightcol">
        <div class="mini">
          <h3>Acciones rápidas</h3>
          <p class="small">
            • <span class="kbd">Imprimir</span> como PDF para comité<br/>
            • Timeline para “replay” del tráfico<br/>
            • Mostrar “Ciudades + resultados” (cards grandes)
          </p>
          <div class="sep"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <a class="btn primary" href="#" onclick="window.print(); return false;">Imprimir / PDF</a>
            <a class="btn" href="#ciudades">Ver resultados</a>
          </div>
        </div>

        <div class="mini" id="waze">
          <h3>Modo Waze (previsto)</h3>
          <p class="notice">
            Waze for Cities permite a entidades públicas monitorear incidentes y compartir cierres/obras con Waze/Google Maps.
            Activación sujeta a autorización/partenariado.
          </p>
          <div class="sep"></div>
          <p class="small mono">Estado: <b>EN ESPERA</b> (solicitud institucional)</p>
        </div>

        <div class="mini">
          <h3>Compatibilidad Google Maps</h3>
          <p class="small">
            La UI está preparada para alternar base map. Por seguridad, no se incluye API key aquí.
          </p>
          <div class="sep"></div>
          <p class="small mono">API Key: <b>no incluida</b></p>
        </div>
      </div>
    </div>

    <!-- MID: Map + Controls -->
    <div class="mid" id="mapa">
      <div class="panel">
        <div class="section-title">
          <h2>Mapa operativo (Lima)</h2>
          <span>OSM listo · rutas “snap” a calles · timeline</span>
        </div>

        <div id="map" aria-label="Mapa de tráfico y eventos"></div>

        <!-- Timeline -->
        <div class="timeline" aria-label="Timeline de congestión">
          <div class="t-top">
            <div class="left">
              <button id="btnPlay" class="btn primary" type="button">▶ Reproducir</button>
              <button id="btnStepBack" class="btn ghost" type="button">⟵</button>
              <button id="btnStepFwd" class="btn ghost" type="button">⟶</button>
              <span class="pill"><span class="dot ok"></span> Histórico (demo)</span>
            </div>
            <div class="stamp">Tiempo: <span id="tLabel" class="mono">—</span></div>
          </div>
          <input id="tSlider" class="slider" type="range" min="0" max="9" step="1" value="0" />
          <p class="notice" style="margin-top:10px">
            Este “replay” sirve como prueba visual de un histórico: es lo que luego alimenta la calibración del modelo (baseline) y la simulación.
          </p>
        </div>

        <div class="sep"></div>
        <p class="notice">
          Demo interna: congestión/incident layers son mock. Se sustituyen por datos reales cuando se conecten fuentes institucionales o proveedores autorizados.
        </p>
      </div>

      <div class="controls">
        <div class="control">
          <h4>Capas (demo)</h4>

          <div class="row">
            <label><input id="tgTraffic" class="toggle" type="checkbox" checked /> Congestión (snap-to-road)</label>
          </div>

          <div class="row">
            <label><input id="tgIncidents" class="toggle" type="checkbox" checked /> Incidentes (mock)</label>
          </div>

          <div class="row">
            <label><input id="tgClosures" class="toggle" type="checkbox" /> Cierres / obras (mock)</label>
          </div>
        </div>

        <div class="control">
          <h4>Base map</h4>

          <div class="row">
            <label><input id="bmOSM" class="toggle" type="checkbox" checked /> OpenStreetMap (Leaflet)</label>
          </div>

          <div class="row">
            <label title="Requiere API Key"><input id="bmGoogle" class="toggle" type="checkbox" /> Google Maps (requiere key)</label>
          </div>

          <div class="row">
            <label title="Disponible con autorización / Waze for Cities"><input id="bmWaze" class="toggle" type="checkbox" /> Waze (previsto / autorización)</label>
          </div>

          <div class="sep"></div>
          <p class="notice">
            Nota: Google/Waze no se cargan por defecto (key/permiso). OSM queda como fallback seguro.
          </p>
        </div>

        <div class="control">
          <h4>Vista rápida</h4>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" onclick="flyTo('miraflores')">Miraflores</button>
            <button class="btn" onclick="flyTo('centro')">Centro</button>
            <button class="btn" onclick="flyTo('aeropuerto')">Aeropuerto</button>
          </div>
          <div class="sep"></div>
          <p class="notice">
            Ajusta estos presets según el distrito piloto definido con el Ministerio.
          </p>
        </div>

        <div class="control">
          <h4>Estado de “snap-to-road”</h4>
          <p id="snapStatus" class="notice">Inicializando…</p>
        </div>
      </div>
    </div>

    <!-- Ciudades + resultados (bigger focus) -->
    <section id="ciudades">
      <div class="panel">
        <div class="section-title">
          <h2>Ciudades que ya lo hacen + resultados (referencias)</h2>
          <span>Bloques reforzados + iconos</span>
        </div>

        <div class="benefit-grid">
          <div class="benefit">
            <div class="b-head">
              <div class="icon" aria-hidden="true">
                <!-- city icon -->
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                  <path d="M4 21V9l8-4 8 4v12" stroke="rgba(255,255,255,.85)" stroke-width="1.6" stroke-linejoin="round"/>
                  <path d="M9 21V12h6v9" stroke="rgba(255,255,255,.85)" stroke-width="1.6" stroke-linejoin="round"/>
                </svg>
              </div>
              <div>
                <h3 class="b-title">Londres (TfL) — colaboración de datos (Waze for Cities)</h3>
                <p class="b-sub">
                  Referencia institucional pública: participación en programa de intercambio de información de tráfico/incidentes para mejorar coordinación y visibilidad.
                </p>
              </div>
            </div>
            <div class="b-metrics">
              <div class="metric">
                <div class="n">Datos + incidentes</div>
                <div class="l">Visibilidad operativa</div>
              </div>
              <div class="metric">
                <div class="n">Coordinación</div>
                <div class="l">Obras / eventos / cierres</div>
              </div>
            </div>
            <div class="hint">Uso aquí: demostrar viabilidad de colaboración pública + enfoque “bajo riesgo”.</div>
          </div>

          <div class="benefit">
            <div class="b-head">
              <div class="icon" aria-hidden="true">
                <!-- building icon -->
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                  <path d="M6 22V3h12v19" stroke="rgba(255,255,255,.85)" stroke-width="1.6" stroke-linejoin="round"/>
                  <path d="M9 7h1M9 11h1M9 15h1M14 7h1M14 11h1M14 15h1" stroke="rgba(255,255,255,.85)" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
              </div>
              <div>
                <h3 class="b-title">Paris — participación pública (Waze for Cities)</h3>
                <p class="b-sub">
                  Existencia de deliberación pública relativa a la participación. Sirve como precedente de adopción institucional.
                </p>
              </div>
            </div>
            <div class="b-metrics">
              <div class="metric">
                <div class="n">Precedente</div>
                <div class="l">Marco público/municipal</div>
              </div>
              <div class="metric">
                <div class="n">Datos compartidos</div>
                <div class="l">Cierres / eventos</div>
              </div>
            </div>
            <div class="hint">Uso aquí: “esto ya se hace en capitales”, sin prometer cifras para Lima.</div>
          </div>

          <div class="benefit">
            <div class="b-head">
              <div class="icon" aria-hidden="true">
                <!-- traffic light icon -->
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                  <path d="M10 2h4v20h-4z" stroke="rgba(255,255,255,.85)" stroke-width="1.6"/>
                  <circle cx="12" cy="6" r="1.8" stroke="rgba(255,255,255,.85)" stroke-width="1.6"/>
                  <circle cx="12" cy="12" r="1.8" stroke="rgba(255,255,255,.85)" stroke-width="1.6"/>
                  <circle cx="12" cy="18" r="1.8" stroke="rgba(255,255,255,.85)" stroke-width="1.6"/>
                </svg>
              </div>
              <div>
                <h3 class="b-title">Optimización “clásica” (sin IA generativa): SCOOT / SCATS</h3>
                <p class="b-sub">
                  Sistemas adaptativos de semáforos y control de tráfico con beneficios medibles (según material público). Sirve para mostrar que incluso sin “IA”, la optimización aporta resultados.
                </p>
              </div>
            </div>
            <div class="b-metrics">
              <div class="metric">
                <div class="n">~12%</div>
                <div class="l">↓ demora (SCOOT, promedio donde instalado)</div>
              </div>
              <div class="metric">
                <div class="n">~8%</div>
                <div class="l">↓ paradas (SCOOT)</div>
              </div>
              <div class="metric">
                <div class="n">28% / 25%</div>
                <div class="l">↓ tiempo / ↓ paradas (SCATS, brochure)</div>
              </div>
            </div>
            <div class="hint">Urban Flow se posiciona como: datos + histórico + simulación + piloto supervisado.</div>
          </div>

          <div class="benefit">
            <div class="b-head">
              <div class="icon" aria-hidden="true">
                <!-- globe icon -->
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                  <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="rgba(255,255,255,.85)" stroke-width="1.6"/>
                  <path d="M2 12h20" stroke="rgba(255,255,255,.85)" stroke-width="1.6"/>
                  <path d="M12 2c3 3 3 17 0 20-3-3-3-17 0-20Z" stroke="rgba(255,255,255,.85)" stroke-width="1.6"/>
                </svg>
              </div>
              <div>
                <h3 class="b-title">Escala de programas de datos públicos</h3>
                <p class="b-sub">
                  Programas tipo “for Cities” se plantean como colaboración a gran escala con múltiples ciudades. Útil para reforzar viabilidad institucional.
                </p>
              </div>
            </div>
            <div class="b-metrics">
              <div class="metric">
                <div class="n">Escalable</div>
                <div class="l">Modelo multi-ciudad</div>
              </div>
              <div class="metric">
                <div class="n">Bajo riesgo</div>
                <div class="l">Primero datos, luego piloto</div>
              </div>
            </div>
            <div class="hint">Mensaje: “empezar pequeño, medir, escalar”.</div>
          </div>
        </div>

        <div class="sep"></div>
        <p class="notice">
          <b>Importante (tono institucional):</b> usar estas referencias como “prueba de viabilidad” y “beneficios medibles”,
          sin prometer el mismo impacto para Lima hasta tener baseline + piloto.
        </p>
      </div>
    </section>

    <div class="footer">
      <span>© <span id="y"></span> · Urban Flow (uso interno) · OSM listo · Snap-to-road + timeline</span>
      <span class="pill"><span class="dot ok"></span> Fallback seguro: OSM</span>
    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    document.getElementById("y").textContent = new Date().getFullYear();

    // ====== CONFIG ======
    const YOUR_GOOGLE_MAPS_API_KEY = ""; // (opcional) no usada aquí

    // Centro inicial (Lima)
    const LIMA = { lat: -12.0464, lng: -77.0428, z: 12 };

    // OSRM public endpoint (snap-to-road via route)
    // Nota: es un endpoint público. Para producción, lo ideal es usar tu propio OSRM o proveedor.
    const OSRM_ROUTE = "https://router.project-osrm.org/route/v1/driving/";

    // ====== Map init (OSM) ======
    const map = L.map('map', { zoomControl: true }).setView([LIMA.lat, LIMA.lng], LIMA.z);

    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Base layers (placeholders)
    let googleLayer = null;
    let wazeLayer = null;

    // ====== Layers ======
    const trafficLayer = L.layerGroup().addTo(map);
    const incidentsLayer = L.layerGroup().addTo(map);
    const closuresLayer = L.layerGroup(); // off by default

    // ====== Timeline model (demo) ======
    // 10 pasos temporales (replay). Ajusta a 24h/7d/etc. cuando tengas datos reales.
    const timeline = Array.from({length: 10}).map((_,i)=>{
      const h = (8 + i) % 24;
      return `2026-02-19 ${String(h).padStart(2,'0')}:00`;
    });

    // Segment definitions (anchors). The route geometry will be snapped via OSRM.
    // Each segment has severity per timeline step (low/med/high)
    const segmentDefs = [
      {
        id: "segA",
        name: "Eje A (mock)",
        anchors: [
          [-12.089, -77.050],
          [-12.080, -77.038],
          [-12.070, -77.030],
        ],
        levels: ["med","high","high","med","med","low","low","med","high","high"]
      },
      {
        id: "segB",
        name: "Eje B (mock)",
        anchors: [
          [-12.060, -77.080],
          [-12.050, -77.070],
          [-12.042, -77.060],
        ],
        levels: ["low","low","med","med","med","low","low","low","med","med"]
      },
      {
        id: "segC",
        name: "Eje C (mock)",
        anchors: [
          [-12.030, -77.045],
          [-12.020, -77.040],
          [-12.010, -77.036],
        ],
        levels: ["low","med","med","low","low","low","med","med","low","low"]
      }
    ];

    // Will store snapped polylines
    const segmentLines = new Map(); // id -> L.Polyline

    // ====== Styling ======
    function styleBy(level){
      const color = level==="high" ? "#fb7185" : (level==="med" ? "#fbbf24" : "#34d399");
      const weight = level==="high" ? 7 : (level==="med" ? 6 : 5);
      return { color, weight, opacity: 0.88, lineCap:"round", lineJoin:"round" };
    }

    // ====== OSRM snap-to-road ======
    async function snapRouteOSRM(anchors){
      // Build coords string "lon,lat;lon,lat;..."
      const coords = anchors.map(([lat,lng]) => `${lng},${lat}`).join(";");
      const url = `${OSRM_ROUTE}${coords}?overview=full&geometries=geojson&steps=false`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`OSRM HTTP ${res.status}`);
      const json = await res.json();
      const route = json?.routes?.[0];
      const geom = route?.geometry?.coordinates; // [lon,lat]
      if(!geom || !geom.length) throw new Error("OSRM no geometry");
      // Convert to Leaflet latlngs
      return geom.map(([lon,lat]) => [lat,lon]);
    }

    function addIncidentsMock(){
      incidentsLayer.clearLayers();
      const incidents = [
        { lat:-12.076, lng:-77.037, type:"Accidente (mock)", sev:"Alta", note:"Posible carril bloqueado" },
        { lat:-12.048, lng:-77.060, type:"Vehículo detenido (mock)", sev:"Media", note:"Requiere verificación" },
        { lat:-12.017, lng:-77.043, type:"Obstáculo (mock)", sev:"Baja", note:"Reporte ciudadano" }
      ];
      incidents.forEach(i=>{
        const color = i.sev==="Alta" ? "#fb7185" : (i.sev==="Media" ? "#fbbf24" : "#34d399");
        const marker = L.circleMarker([i.lat,i.lng], {
          radius:9, color:color, fillColor:color, fillOpacity:0.85, weight:2
        }).bindPopup(
          `<b>Incidente</b><br/>${i.type}<br/><span class="mono">Severidad:</span> ${i.sev}<br/>${i.note}`
        );
        incidentsLayer.addLayer(marker);
      });
    }

    function addClosuresMock(){
      closuresLayer.clearLayers();
      const area = L.polygon(
        [[-12.062,-77.055],[-12.056,-77.048],[-12.050,-77.052],[-12.052,-77.060]],
        { color:"#a78bfa", fillColor:"#a78bfa", fillOpacity:0.18, weight:2 }
      ).bindPopup("<b>Cierre / Obra (mock)</b><br/>Zona afectada — desvío sugerido");
      closuresLayer.addLayer(area);
    }

    addIncidentsMock();
    addClosuresMock();

    // ====== Traffic render ======
    let tIndex = 0;

    function updateTimelineLabel(){
      document.getElementById("tLabel").textContent = timeline[tIndex] ?? "—";
    }

    function updateTrafficStyles(){
      segmentDefs.forEach(def=>{
        const lvl = def.levels[tIndex] ?? "low";
        const line = segmentLines.get(def.id);
        if(!line) return;
        line.setStyle(styleBy(lvl));
        line.setPopupContent(
          `<b>Congestión</b><br/>${def.name}<br/><span class="mono">Nivel:</span> ${lvl}<br/><span class="mono">Tiempo:</span> ${timeline[tIndex]}`
        );
      });
    }

    async function buildTrafficLayer(){
      trafficLayer.clearLayers();
      segmentLines.clear();

      const status = document.getElementById("snapStatus");
      status.textContent = "Generando rutas sobre calles (OSRM)…";

      let snappedOK = 0;
      for (const def of segmentDefs){
        let latlngs = null;
        try{
          latlngs = await snapRouteOSRM(def.anchors);
          snappedOK += 1;
        }catch(err){
          // fallback to anchors as straight segments
          latlngs = def.anchors;
        }

        const lvl = def.levels[tIndex] ?? "low";
        const line = L.polyline(latlngs, styleBy(lvl))
          .bindPopup(
            `<b>Congestión</b><br/>${def.name}<br/><span class="mono">Nivel:</span> ${lvl}<br/><span class="mono">Tiempo:</span> ${timeline[tIndex]}`
          );

        trafficLayer.addLayer(line);
        segmentLines.set(def.id, line);
      }

      if(snappedOK === segmentDefs.length){
        status.textContent = `OK: rutas alineadas a calles (OSRM) · ${snappedOK}/${segmentDefs.length}`;
      }else{
        status.textContent = `Parcial: OSRM ${snappedOK}/${segmentDefs.length} · fallback en algunas rutas (líneas simples)`;
      }

      updateTrafficStyles();
    }

    // ====== UI toggles ======
    const tgTraffic = document.getElementById("tgTraffic");
    const tgIncidents = document.getElementById("tgIncidents");
    const tgClosures = document.getElementById("tgClosures");

    tgTraffic.addEventListener("change", ()=> tgTraffic.checked ? trafficLayer.addTo(map) : map.removeLayer(trafficLayer));
    tgIncidents.addEventListener("change", ()=> tgIncidents.checked ? incidentsLayer.addTo(map) : map.removeLayer(incidentsLayer));
    tgClosures.addEventListener("change", ()=> tgClosures.checked ? closuresLayer.addTo(map) : map.removeLayer(closuresLayer));

    // Base map toggles (OSM always available)
    const bmOSM = document.getElementById("bmOSM");
    const bmGoogle = document.getElementById("bmGoogle");
    const bmWaze = document.getElementById("bmWaze");

    function resetBaseToggles(except){
      ["bmOSM","bmGoogle","bmWaze"].forEach(id=>{
        if(id!==except) document.getElementById(id).checked = false;
      });
    }

    bmOSM.addEventListener("change", ()=>{
      if(!bmOSM.checked){ bmOSM.checked = true; return; }
      resetBaseToggles("bmOSM");
      if(!map.hasLayer(osm)) osm.addTo(map);
      if(googleLayer && map.hasLayer(googleLayer)) map.removeLayer(googleLayer);
      if(wazeLayer && map.hasLayer(wazeLayer)) map.removeLayer(wazeLayer);
    });

    bmGoogle.addEventListener("change", async ()=>{
      if(!bmGoogle.checked) return;
      resetBaseToggles("bmGoogle");

      alert("Integración Google Maps: prevista (requiere implementación aprobada + API key). Se mantiene OSM como base en esta demo.");
      bmOSM.checked = true; bmGoogle.checked = false;
    });

    bmWaze.addEventListener("change", ()=>{
      if(!bmWaze.checked) return;
      resetBaseToggles("bmWaze");
      alert("Waze: previsto vía Waze for Cities (feeds / Partner Hub). Requiere autorización institucional. Se mantiene OSM como base.");
      bmOSM.checked = true; bmWaze.checked = false;
    });

    // Presets (ajusta según piloto)
    const presets = {
      miraflores: { lat:-12.121, lng:-77.030, z: 13 },
      centro: { lat:-12.0464, lng:-77.0428, z: 13 },
      aeropuerto: { lat:-12.0219, lng:-77.1143, z: 12 }
    };
    window.flyTo = (k)=>{
      const p = presets[k] || LIMA;
      map.flyTo([p.lat,p.lng], p.z, { duration: 0.9 });
    };

    // Smooth anchors
    document.querySelectorAll('a[href^="#"]').forEach(a=>{
      a.addEventListener('click',(e)=>{
        const id=a.getAttribute('href'); if(!id||id==="#") return;
        const el=document.querySelector(id); if(!el) return;
        e.preventDefault(); el.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });

    // ====== Timeline controls ======
    const tSlider = document.getElementById("tSlider");
    const btnPlay = document.getElementById("btnPlay");
    const btnStepBack = document.getElementById("btnStepBack");
    const btnStepFwd = document.getElementById("btnStepFwd");

    let playing = false;
    let timer = null;
    const FPS_MS = 700; // vitesse replay (accéléré)

    function setIndex(i){
      tIndex = Math.max(0, Math.min(timeline.length - 1, i));
      tSlider.value = String(tIndex);
      updateTimelineLabel();
      updateTrafficStyles();
    }

    function play(){
      if(playing) return;
      playing = true;
      btnPlay.textContent = "⏸ Pausar";
      timer = setInterval(()=>{
        if(tIndex >= timeline.length - 1){
          // loop
          setIndex(0);
        }else{
          setIndex(tIndex + 1);
        }
      }, FPS_MS);
    }

    function pause(){
      playing = false;
      btnPlay.textContent = "▶ Reproducir";
      if(timer) clearInterval(timer);
      timer = null;
    }

    btnPlay.addEventListener("click", ()=>{
      playing ? pause() : play();
    });
    btnStepBack.addEventListener("click", ()=> setIndex(tIndex - 1));
    btnStepFwd.addEventListener("click", ()=> setIndex(tIndex + 1));
    tSlider.addEventListener("input", (e)=>{
      pause();
      setIndex(parseInt(e.target.value, 10));
    });

    // Init
    updateTimelineLabel();
    buildTrafficLayer().catch(()=>{
      document.getElementById("snapStatus").textContent = "Error OSRM: usando fallback (líneas simples).";
    });
  </script>
</body>
</html>
