<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Urban Flow ‚Äî Centro de Control (Demo) ¬∑ Lima</title>
  <meta name="description" content="Centro de control: mapa OSM + congestion snap-to-road + timeline + incidentes + corredor hospitalario (onda verde) en modo demo institucional." />
  <link rel="preconnect" href="https://tile.openstreetmap.org" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --line:rgba(255,255,255,.14);
      --shadow: 0 22px 70px rgba(0,0,0,.45);
      --radius: 18px;
      --accent:#67e8f9;
      --accent2:#a78bfa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --bg0:#070a14;
      --bg1:#0b1020;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(103,232,249,.16), transparent 55%),
        radial-gradient(900px 600px at 85% 30%, rgba(167,139,250,.16), transparent 55%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 45%, var(--bg0) 100%);
      overflow-x:hidden;
    }
    a{color:inherit}

    .nav{
      position:sticky;top:0;z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(7,10,20,.82), rgba(7,10,20,.46));
      border-bottom:1px solid var(--line);
    }
    .nav-inner{
      max-width:1320px;margin:0 auto;
      padding:10px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, rgba(103,232,249,.95), rgba(167,139,250,.95));
      box-shadow: 0 12px 26px rgba(103,232,249,.14);
      position:relative;overflow:hidden;
    }
    .logo:after{
      content:"";position:absolute;inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 45%);
      transform: rotate(12deg);
      animation: drift 8s ease-in-out infinite;
      opacity:.55;
    }
    @keyframes drift{
      0%,100%{transform:translate(0,0) rotate(12deg)}
      50%{transform:translate(14px,-10px) rotate(12deg)}
    }
    .brand h1{margin:0;font-size:13px;letter-spacing:.25px;color:var(--muted);font-weight:780}
    .nav-links{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .nav-links a{
      text-decoration:none;
      padding:8px 10px;border-radius:999px;
      border:1px solid transparent;
      color:var(--muted);
      transition:.18s ease;
      font-size:12px;
    }
    .nav-links a:hover{border-color:var(--line);color:var(--text);background:rgba(255,255,255,.04)}

    .wrap{max-width:1320px;margin:0 auto;padding:16px 16px 70px}

    .panel{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .panel:before{
      content:"";position:absolute;inset:-1px;
      background: radial-gradient(800px 220px at 20% 0%, rgba(103,232,249,.14), transparent 55%),
                  radial-gradient(800px 220px at 80% 0%, rgba(167,139,250,.12), transparent 55%);
      pointer-events:none;
      opacity:.90;
    }
    .panel > *{position:relative}

    .section-title{
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
      margin:0 0 10px;
    }
    .section-title h2{margin:0;font-size:16px;letter-spacing:-.2px}
    .section-title span{color:var(--muted);font-size:12.2px}

    /* KPI Row */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:12px;
      margin-bottom:14px;
    }
    .kpi{
      grid-column:span 3;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: 20px;
      padding:14px;
      position:relative;
      overflow:hidden;
      min-height: 92px;
    }
    @media(max-width:1020px){.kpi{grid-column:span 6}}
    @media(max-width:560px){.kpi{grid-column:span 12}}
    .kpi:before{
      content:"";position:absolute;inset:-1px;
      background: radial-gradient(700px 220px at 15% 0%, rgba(103,232,249,.12), transparent 55%),
                  radial-gradient(700px 220px at 85% 0%, rgba(167,139,250,.10), transparent 55%);
      opacity:.9;pointer-events:none;
    }
    .kpi > *{position:relative}
    .kpi .top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .kpi .label{color:var(--muted);font-size:12.2px}
    .kpi .val{font-size:22px;font-weight:930;letter-spacing:-.4px;margin-top:6px}
    .kpi .sub{color:var(--muted);font-size:12.1px;margin-top:6px;line-height:1.4}
    .kpi .badge{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* Mid layout */
    .mid{
      display:grid;
      grid-template-columns: 1.45fr .55fr;
      gap:14px;
      align-items:stretch;
    }
    @media(max-width:1020px){.mid{grid-template-columns:1fr}}

    #map{
      width:100%;
      height:610px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:#0a0f1f;
    }
    @media(max-width:620px){#map{height:520px}}

    .controls{display:grid;gap:10px}
    .control{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
    }
    .control h4{margin:0 0 10px;font-size:12.8px;color:var(--text)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
    .row label{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:12.3px;cursor:pointer}

    .toggle{
      appearance:none;
      width:44px;height:26px;border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      position:relative;
      outline:none;
      cursor:pointer;
      transition:.18s ease;
    }
    .toggle:after{
      content:"";
      position:absolute;top:50%;left:4px;
      width:18px;height:18px;border-radius:50%;
      transform:translateY(-50%);
      background:rgba(255,255,255,.88);
      transition:.18s ease;
    }
    .toggle:checked{
      background:rgba(103,232,249,.25);
      border-color:rgba(103,232,249,.45);
    }
    .toggle:checked:after{left:22px;background:#071022}

    .btn{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:var(--text);
      text-decoration:none;
      font-weight:860;
      font-size:12.5px;
      transition:.18s ease;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
    .btn.primary{
      border-color:transparent;
      background: linear-gradient(135deg, rgba(103,232,249,.95), rgba(167,139,250,.95));
      color:#071022;
    }
    .btn.ghost{background:rgba(255,255,255,.03)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .notice{color:var(--muted);font-size:12.2px;line-height:1.55;margin:0}
    .em{color:rgba(255,255,255,.86);font-weight:860}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* Timeline */
    .timeline{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
      margin-top:12px;
    }
    .t-top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .t-top .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .t-top .stamp{color:var(--muted);font-size:12.2px}
    .slider{width:100%;margin-top:10px;accent-color: var(--accent);}

    /* Mini chart */
    .chart-wrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }
    canvas{
      width:100%;
      height:120px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      display:block;
    }

    /* Incidents side */
    .inc-header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .inc-header h4{margin:0;font-size:12.8px}
    .search{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px 12px;
      color:var(--text);
      outline:none;
      font-size:12.5px;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      transition:.18s ease;
    }
    .chip.active{border-color:rgba(103,232,249,.45); background:rgba(103,232,249,.12); color:rgba(255,255,255,.86)}
    .inc-list{
      margin-top:10px;
      display:grid;
      gap:10px;
      max-height: 350px;
      overflow:auto;
      padding-right:6px;
    }
    .inc{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
      cursor:pointer;
      transition:.18s ease;
    }
    .inc:hover{transform:translateY(-1px); background:rgba(255,255,255,.04)}
    .inc .toprow{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .inc .type{font-weight:900;font-size:12.8px;letter-spacing:-.15px}
    .inc .meta{color:var(--muted);font-size:12.2px;margin-top:6px;line-height:1.45}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .legend{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:10px
    }

    /* Emergency strip */
    .emg{
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:16px;
      padding:12px;
    }
    .emg .head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .emg .title{font-weight:900;letter-spacing:-.2px}
    .emg .meta{color:var(--muted);font-size:12.2px;line-height:1.45;margin-top:8px}
    .emg .row2{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .emg .stat{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px 12px;
      min-width: 140px;
    }
    .emg .stat .n{font-size:14px;font-weight:950}
    .emg .stat .l{color:var(--muted);font-size:12.1px;margin-top:4px}
    .footer{
      margin-top:18px;
      color:var(--muted);
      font-size:12.2px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
  </style>
</head>

<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Urban Flow ¬∑ Centro de Control (Demo) ‚Äî Lima</h1>
      </div>
      <div class="nav-links">
        <a href="#control">Control</a>
        <a href="#mapa">Mapa</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel" id="control">
      <div class="section-title">
        <h2>Estado operativo (KPI) ¬∑ sincronizado con la timeline</h2>
        <span>modo demo institucional ¬∑ sin promesas (baseline ‚Üí piloto ‚Üí KPI reales)</span>
      </div>

      <div class="kpi-grid">
        <div class="kpi">
          <div class="top">
            <div class="label">Congesti√≥n promedio</div>
            <span class="badge"><span class="dot warn"></span> Hist√≥rico</span>
          </div>
          <div id="kpiCong" class="val">‚Äî</div>
          <div id="kpiCongSub" class="sub">‚Äî</div>
        </div>

        <div class="kpi">
          <div class="top">
            <div class="label">Incidentes activos</div>
            <span class="badge"><span class="dot bad"></span> Operativo</span>
          </div>
          <div id="kpiInc" class="val">‚Äî</div>
          <div id="kpiIncSub" class="sub">‚Äî</div>
        </div>

        <div class="kpi">
          <div class="top">
            <div class="label">√çndice de fluidez</div>
            <span class="badge"><span class="dot ok"></span> Score</span>
          </div>
          <div id="kpiFlow" class="val">‚Äî</div>
          <div id="kpiFlowSub" class="sub">‚Äî</div>
        </div>

        <div class="kpi">
          <div class="top">
            <div class="label">ETA Emergencias (demo)</div>
            <span class="badge"><span class="dot ok"></span> Onda verde</span>
          </div>
          <div id="kpiEta" class="val">‚Äî</div>
          <div id="kpiEtaSub" class="sub">Activar ‚ÄúCorredor Hospitalario‚Äù</div>
        </div>
      </div>

      <div class="chart-wrap">
        <canvas id="miniChart" width="1200" height="240" aria-label="Mini chart KPI"></canvas>
      </div>
    </div>

    <div class="panel" id="mapa" style="margin-top:14px">
      <div class="section-title">
        <h2>Mapa operativo (Lima)</h2>
        <span>~15 rutas snap-to-road ¬∑ timeline ¬∑ incidentes ¬∑ corredor hospitalario</span>
      </div>

      <div class="mid">
        <!-- LEFT: MAP + TIMELINE -->
        <div>
          <div id="map" aria-label="Mapa de tr√°fico y eventos"></div>

          <div class="timeline" aria-label="Timeline de congesti√≥n">
            <div class="t-top">
              <div class="left">
                <button id="btnPlay" class="btn primary" type="button">‚ñ∂ Reproducir</button>
                <button id="btnStepBack" class="btn ghost" type="button">‚üµ</button>
                <button id="btnStepFwd" class="btn ghost" type="button">‚ü∂</button>
                <span class="pill"><span class="dot ok"></span> Hist√≥rico (demo)</span>
              </div>
              <div class="stamp">Tiempo: <span id="tLabel" class="mono">‚Äî</span></div>
            </div>
            <input id="tSlider" class="slider" type="range" min="0" max="11" step="1" value="0" />
            <div class="legend">
              <span class="badge"><span class="dot bad"></span> Alta</span>
              <span class="badge"><span class="dot warn"></span> Media</span>
              <span class="badge"><span class="dot ok"></span> Baja</span>
              <span class="badge">Rutas: <b id="routeCount">‚Äî</b></span>
              <span class="badge">Incidentes visibles: <b id="incCount">‚Äî</b></span>
            </div>
            <div class="sep"></div>
            <p class="notice">
              En producci√≥n, la timeline se alimenta de hist√≥rico real y sirve para calibraci√≥n del modelo y simulaci√≥n.
            </p>
          </div>
        </div>

        <!-- RIGHT: INCIDENTS + CONTROLS -->
        <div class="controls">

          <div class="emg">
            <div class="head">
              <div class="title">üöë Corredor Hospitalario (Waouh+)</div>
              <button id="btnCorridor" class="btn primary" type="button">Activar</button>
            </div>
            <div class="meta">
              Calcula una ruta (OSRM) y simula ‚Äúonda verde‚Äù (demo). Ideal para explicar prioridad de emergencias de forma supervisada.
            </div>
            <div class="row2">
              <div class="stat">
                <div id="emgDist" class="n">‚Äî</div>
                <div class="l">Distancia</div>
              </div>
              <div class="stat">
                <div id="emgEta" class="n">‚Äî</div>
                <div class="l">ETA estimada</div>
              </div>
              <div class="stat">
                <div id="emgMode" class="n">OFF</div>
                <div class="l">Estado</div>
              </div>
            </div>
          </div>

          <div class="control">
            <h4>Capas</h4>
            <div class="row">
              <label><input id="tgTraffic" class="toggle" type="checkbox" checked /> Congesti√≥n (snap-to-road)</label>
            </div>
            <div class="row">
              <label><input id="tgIncidents" class="toggle" type="checkbox" checked /> Incidentes</label>
            </div>
            <div class="row">
              <label><input id="tgClosures" class="toggle" type="checkbox" /> Cierres / obras</label>
            </div>
            <div class="sep"></div>
            <p id="snapStatus" class="notice">Inicializando‚Ä¶</p>
          </div>

          <div class="control">
            <div class="inc-header">
              <h4>Incidentes (vista lateral)</h4>
              <span class="pill"><span class="dot warn"></span> Live-like</span>
            </div>

            <input id="q" class="search" placeholder="Buscar (ej.: accidente, obra, v√≠a, distrito)‚Ä¶" />

            <div class="chips">
              <div class="chip active" data-filter="all">Todos</div>
              <div class="chip" data-filter="Alta">Alta</div>
              <div class="chip" data-filter="Media">Media</div>
              <div class="chip" data-filter="Baja">Baja</div>
              <div class="chip" data-filter="Cierre">Cierres</div>
            </div>

            <div id="incList" class="inc-list" aria-label="Lista de incidentes"></div>

            <div class="sep"></div>
            <p class="notice">
              Clic en un incidente: zoom + popup + highlight. La lista se sincroniza con la timeline.
            </p>
          </div>

          <div class="control">
            <h4>Vista r√°pida</h4>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn" onclick="flyTo('miraflores')">Miraflores</button>
              <button class="btn" onclick="flyTo('centro')">Centro</button>
              <button class="btn" onclick="flyTo('aeropuerto')">Aeropuerto</button>
            </div>
            <div class="sep"></div>
            <p class="notice">Ajusta presets seg√∫n distrito piloto definido con el Ministerio.</p>
          </div>

        </div>
      </div>

      <div class="footer">
        <span>¬© <span id="y"></span> ¬∑ Urban Flow (uso interno) ¬∑ OSM + OSRM (demo)</span>
        <span class="pill"><span class="dot ok"></span> Fallback seguro: OSM</span>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    document.getElementById("y").textContent = new Date().getFullYear();

    // ====== CONFIG ======
    const LIMA = { lat: -12.0464, lng: -77.0428, z: 12 };
    const OSRM_ROUTE = "https://router.project-osrm.org/route/v1/driving/";

    // Emergency (demo) endpoints: (Miraflores -> Hospital area / Centro)
    // Ajuste rapide: remplace ces coords avec h√¥pital r√©el + zone d‚Äôintervention, si besoin.
    const EMG = {
      from: { name:"Miraflores (demo)", lat:-12.1210, lng:-77.0300 },
      to:   { name:"Cercado / Hospital (demo)", lat:-12.0565, lng:-77.0460 }
    };

    // ====== Map init ======
    const map = L.map('map', { zoomControl: true }).setView([LIMA.lat, LIMA.lng], LIMA.z);
    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ====== Layers ======
    const trafficLayer = L.layerGroup().addTo(map);
    const incidentsLayer = L.layerGroup().addTo(map);
    const closuresLayer = L.layerGroup(); // off by default
    const corridorLayer = L.layerGroup().addTo(map); // on demand (polyline + moving marker)

    // ====== Timeline ======
    const timeline = Array.from({length: 12}).map((_,i)=>{
      const h = (7 + i) % 24;
      return `2026-02-19 ${String(h).padStart(2,'0')}:00`;
    });
    const tSlider = document.getElementById("tSlider");
    tSlider.max = String(timeline.length - 1);

    let tIndex = 0;
    function updateTimelineLabel(){
      document.getElementById("tLabel").textContent = timeline[tIndex] ?? "‚Äî";
    }

    // ====== Severity styles ======
    function styleBy(level){
      const color = level==="high" ? "#fb7185" : (level==="med" ? "#fbbf24" : "#34d399");
      const weight = level==="high" ? 7 : (level==="med" ? 6 : 5);
      return { color, weight, opacity: 0.88, lineCap:"round", lineJoin:"round" };
    }
    function sevColor(sev){
      if(sev==="Alta") return "#fb7185";
      if(sev==="Media") return "#fbbf24";
      return "#34d399";
    }

    // ====== OSRM snap-to-road ======
    async function snapRouteOSRM(anchors){
      const coords = anchors.map(([lat,lng]) => `${lng},${lat}`).join(";");
      const url = `${OSRM_ROUTE}${coords}?overview=full&geometries=geojson&steps=false`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`OSRM HTTP ${res.status}`);
      const json = await res.json();
      const route = json?.routes?.[0];
      const geom = route?.geometry?.coordinates;
      if(!geom || !geom.length) throw new Error("OSRM no geometry");
      return geom.map(([lon,lat]) => [lat,lon]);
    }

    async function routeOSRM(from, to){
      const coords = `${from.lng},${from.lat};${to.lng},${to.lat}`;
      const url = `${OSRM_ROUTE}${coords}?overview=full&geometries=geojson&steps=false`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`OSRM HTTP ${res.status}`);
      const json = await res.json();
      const route = json?.routes?.[0];
      if(!route) throw new Error("OSRM no route");
      const geom = route.geometry?.coordinates || [];
      const latlngs = geom.map(([lon,lat]) => [lat,lon]);
      return {
        latlngs,
        distance_m: route.distance || 0,
        duration_s: route.duration || 0
      };
    }

    // ====== Build ~15 traffic segments ======
    function mkLevels(seed){
      const base = ["low","low","med","med","high","high","med","low","low","med","high","med"];
      return base.map((v, i)=>{
        const n = (seed * 7 + i * 3) % 10;
        if(n < 2) return "high";
        if(n < 5) return "med";
        return v;
      });
    }

    const segmentDefs = [
      { id:"s1",  name:"Corredor 1 (mock)",  anchors:[[-12.105,-77.060],[-12.095,-77.045],[-12.085,-77.035]], levels:mkLevels(1) },
      { id:"s2",  name:"Corredor 2 (mock)",  anchors:[[-12.090,-77.080],[-12.080,-77.067],[-12.070,-77.055]], levels:mkLevels(2) },
      { id:"s3",  name:"Corredor 3 (mock)",  anchors:[[-12.070,-77.090],[-12.060,-77.075],[-12.050,-77.060]], levels:mkLevels(3) },
      { id:"s4",  name:"Corredor 4 (mock)",  anchors:[[-12.050,-77.085],[-12.045,-77.070],[-12.040,-77.055]], levels:mkLevels(4) },
      { id:"s5",  name:"Corredor 5 (mock)",  anchors:[[-12.040,-77.040],[-12.035,-77.050],[-12.030,-77.060]], levels:mkLevels(5) },
      { id:"s6",  name:"Corredor 6 (mock)",  anchors:[[-12.030,-77.030],[-12.020,-77.040],[-12.010,-77.050]], levels:mkLevels(6) },
      { id:"s7",  name:"Corredor 7 (mock)",  anchors:[[-12.060,-77.040],[-12.055,-77.028],[-12.050,-77.020]], levels:mkLevels(7) },
      { id:"s8",  name:"Corredor 8 (mock)",  anchors:[[-12.075,-77.030],[-12.065,-77.020],[-12.055,-77.015]], levels:mkLevels(8) },
      { id:"s9",  name:"Corredor 9 (mock)",  anchors:[[-12.090,-77.035],[-12.080,-77.025],[-12.070,-77.020]], levels:mkLevels(9) },
      { id:"s10", name:"Corredor 10 (mock)", anchors:[[-12.100,-77.045],[-12.090,-77.040],[-12.080,-77.035]], levels:mkLevels(10) },
      { id:"s11", name:"Corredor 11 (mock)", anchors:[[-12.020,-77.090],[-12.020,-77.070],[-12.020,-77.050]], levels:mkLevels(11) },
      { id:"s12", name:"Corredor 12 (mock)", anchors:[[-12.035,-77.100],[-12.030,-77.085],[-12.025,-77.070]], levels:mkLevels(12) },
      { id:"s13", name:"Corredor 13 (mock)", anchors:[[-12.055,-77.110],[-12.050,-77.095],[-12.045,-77.080]], levels:mkLevels(13) },
      { id:"s14", name:"Corredor 14 (mock)", anchors:[[-12.080,-77.110],[-12.070,-77.095],[-12.060,-77.080]], levels:mkLevels(14) },
      { id:"s15", name:"Corredor 15 (mock)", anchors:[[-12.110,-77.095],[-12.100,-77.085],[-12.090,-77.075]], levels:mkLevels(15) }
    ];

    const segmentLines = new Map();
    let snappedOK = 0;

    function updateTrafficStyles(){
      segmentDefs.forEach(def=>{
        const lvl = def.levels[tIndex] ?? "low";
        const line = segmentLines.get(def.id);
        if(!line) return;
        line.setStyle(styleBy(lvl));
        line.setPopupContent(
          `<b>Congesti√≥n</b><br/>${def.name}<br/><span class="mono">Nivel:</span> ${lvl}<br/><span class="mono">Tiempo:</span> ${timeline[tIndex]}`
        );
      });
    }

    async function buildTrafficLayer(){
      trafficLayer.clearLayers();
      segmentLines.clear();
      snappedOK = 0;

      const status = document.getElementById("snapStatus");
      status.textContent = "Generando rutas sobre calles (OSRM)‚Ä¶";

      for (const def of segmentDefs){
        let latlngs = null;
        try{
          latlngs = await snapRouteOSRM(def.anchors);
          snappedOK += 1;
        }catch(e){
          latlngs = def.anchors; // fallback
        }

        const lvl = def.levels[tIndex] ?? "low";
        const line = L.polyline(latlngs, styleBy(lvl))
          .bindPopup(
            `<b>Congesti√≥n</b><br/>${def.name}<br/><span class="mono">Nivel:</span> ${lvl}<br/><span class="mono">Tiempo:</span> ${timeline[tIndex]}`
          );

        trafficLayer.addLayer(line);
        segmentLines.set(def.id, line);
      }

      document.getElementById("routeCount").textContent = String(segmentDefs.length);

      if(snappedOK === segmentDefs.length){
        status.textContent = `OK: rutas alineadas a calles (OSRM) ¬∑ ${snappedOK}/${segmentDefs.length}`;
      }else{
        status.textContent = `Parcial: OSRM ${snappedOK}/${segmentDefs.length} ¬∑ fallback en algunas rutas`;
      }

      updateTrafficStyles();
    }

    // ====== Incidents synced with timeline ======
    const incidentDefs = [
      { id:"i1", type:"Accidente", sev:"Alta", note:"Posible carril bloqueado", lat:-12.076, lng:-77.037, start:1, end:5, tags:["accidente","v√≠a"] },
      { id:"i2", type:"Veh√≠culo detenido", sev:"Media", note:"Requiere verificaci√≥n", lat:-12.048, lng:-77.060, start:0, end:3, tags:["veh√≠culo"] },
      { id:"i3", type:"Obst√°culo", sev:"Baja", note:"Reporte ciudadano", lat:-12.017, lng:-77.043, start:4, end:9, tags:["obst√°culo"] },
      { id:"i4", type:"Cierre por obra", sev:"Media", note:"Desv√≠o sugerido", lat:-12.055, lng:-77.055, start:2, end:11, tags:["Cierre","obra"] },
      { id:"i5", type:"Evento / marcha", sev:"Alta", note:"Alta densidad", lat:-12.046, lng:-77.042, start:6, end:11, tags:["evento"] },
      { id:"i6", type:"Sem√°foro fuera de servicio", sev:"Media", note:"Gesti√≥n manual", lat:-12.070, lng:-77.055, start:3, end:7, tags:["semaforo"] },
      { id:"i7", type:"Choque menor", sev:"Baja", note:"Tr√°nsito lento", lat:-12.095, lng:-77.045, start:7, end:10, tags:["accidente"] },
      { id:"i8", type:"Cierre parcial", sev:"Media", note:"Carril reducido", lat:-12.020, lng:-77.070, start:0, end:11, tags:["Cierre"] }
    ];

    function isIncidentActive(inc, idx){
      return idx >= inc.start && idx <= inc.end;
    }

    const incidentMarkers = new Map();
    let highlightedMarker = null;

    function renderIncidentMarkers(){
      incidentsLayer.clearLayers();
      incidentMarkers.clear();

      const active = incidentDefs.filter(inc => isIncidentActive(inc, tIndex));
      active.forEach(inc=>{
        const color = sevColor(inc.sev);
        const m = L.circleMarker([inc.lat, inc.lng], {
          radius:9, color, fillColor:color, fillOpacity:0.88, weight:2
        }).bindPopup(
          `<b>Incidente</b><br/>${inc.type}<br/><span class="mono">Severidad:</span> ${inc.sev}<br/><span class="mono">Tiempo:</span> ${timeline[tIndex]}<br/>${inc.note}`
        );
        m.on("click", ()=> focusIncident(inc.id));
        incidentsLayer.addLayer(m);
        incidentMarkers.set(inc.id, m);
      });

      document.getElementById("incCount").textContent = String(active.length);
    }

    function focusIncident(id){
      const inc = incidentDefs.find(x=>x.id===id);
      const m = incidentMarkers.get(id);
      if(!inc || !m) return;

      map.flyTo([inc.lat, inc.lng], Math.max(map.getZoom(), 14), { duration: 0.8 });
      m.openPopup();

      if(highlightedMarker){
        highlightedMarker.setStyle({ weight:2, radius:9 });
      }
      m.setStyle({ weight:4, radius:11 });
      highlightedMarker = m;
    }

    // ====== Incident side list ======
    const incList = document.getElementById("incList");
    const q = document.getElementById("q");
    let activeFilter = "all";

    function matchesFilter(inc){
      if(activeFilter==="all") return true;
      if(activeFilter==="Cierre") return inc.tags.includes("Cierre") || inc.type.toLowerCase().includes("cierre");
      return inc.sev === activeFilter;
    }
    function matchesQuery(inc, query){
      if(!query) return true;
      const s = query.toLowerCase();
      return (
        inc.type.toLowerCase().includes(s) ||
        inc.note.toLowerCase().includes(s) ||
        inc.sev.toLowerCase().includes(s) ||
        inc.tags.some(t => String(t).toLowerCase().includes(s))
      );
    }

    function renderIncidentList(){
      const query = q.value.trim();
      const active = incidentDefs
        .filter(inc => isIncidentActive(inc, tIndex))
        .filter(matchesFilter)
        .filter(inc => matchesQuery(inc, query));

      incList.innerHTML = "";
      if(active.length === 0){
        const empty = document.createElement("div");
        empty.className = "notice";
        empty.textContent = "Sin incidentes para este filtro en el tiempo actual.";
        incList.appendChild(empty);
        return;
      }

      active.forEach(inc=>{
        const el = document.createElement("div");
        el.className = "inc";
        el.innerHTML = `
          <div class="toprow">
            <div>
              <div class="type">${inc.type}</div>
              <div class="meta">
                <span class="badge"><span class="dot ${inc.sev==="Alta"?"bad":(inc.sev==="Media"?"warn":"ok")}"></span>${inc.sev}</span>
                <span class="badge">${timeline[tIndex]}</span>
              </div>
            </div>
            <span class="badge">Ver</span>
          </div>
          <div class="meta" style="margin-top:8px">${inc.note}</div>
        `;
        el.addEventListener("click", ()=> focusIncident(inc.id));
        incList.appendChild(el);
      });
    }

    document.querySelectorAll(".chip").forEach(ch=>{
      ch.addEventListener("click", ()=>{
        document.querySelectorAll(".chip").forEach(x=>x.classList.remove("active"));
        ch.classList.add("active");
        activeFilter = ch.dataset.filter;
        renderIncidentList();
      });
    });
    q.addEventListener("input", ()=> renderIncidentList());

    // ====== Closures mock ======
    function addClosuresMock(){
      closuresLayer.clearLayers();
      const area = L.polygon(
        [[-12.062,-77.055],[-12.056,-77.048],[-12.050,-77.052],[-12.052,-77.060]],
        { color:"#a78bfa", fillColor:"#a78bfa", fillOpacity:0.18, weight:2 }
      ).bindPopup("<b>Cierre / Obra (mock)</b><br/>Zona afectada ‚Äî desv√≠o sugerido");
      closuresLayer.addLayer(area);
    }
    addClosuresMock();

    // ====== Toggles ======
    const tgTraffic = document.getElementById("tgTraffic");
    const tgIncidents = document.getElementById("tgIncidents");
    const tgClosures = document.getElementById("tgClosures");

    tgTraffic.addEventListener("change", ()=> tgTraffic.checked ? trafficLayer.addTo(map) : map.removeLayer(trafficLayer));
    tgIncidents.addEventListener("change", ()=> tgIncidents.checked ? incidentsLayer.addTo(map) : map.removeLayer(incidentsLayer));
    tgClosures.addEventListener("change", ()=> tgClosures.checked ? closuresLayer.addTo(map) : map.removeLayer(closuresLayer));

    // ====== Presets ======
    const presets = {
      miraflores: { lat:-12.121, lng:-77.030, z: 13 },
      centro: { lat:-12.0464, lng:-77.0428, z: 13 },
      aeropuerto: { lat:-12.0219, lng:-77.1143, z: 12 }
    };
    window.flyTo = (k)=>{
      const p = presets[k] || LIMA;
      map.flyTo([p.lat,p.lng], p.z, { duration: 0.9 });
    };

    // ====== KPI / Chart (Waouh+) ======
    const kpiCong = document.getElementById("kpiCong");
    const kpiCongSub = document.getElementById("kpiCongSub");
    const kpiInc = document.getElementById("kpiInc");
    const kpiIncSub = document.getElementById("kpiIncSub");
    const kpiFlow = document.getElementById("kpiFlow");
    const kpiFlowSub = document.getElementById("kpiFlowSub");
    const kpiEta = document.getElementById("kpiEta");
    const kpiEtaSub = document.getElementById("kpiEtaSub");

    function levelToScore(lvl){
      // low=1, med=2, high=3
      if(lvl==="high") return 3;
      if(lvl==="med") return 2;
      return 1;
    }

    function computeKPI(idx){
      const segScores = segmentDefs.map(s => levelToScore(s.levels[idx] || "low"));
      const avg = segScores.reduce((a,b)=>a+b,0) / Math.max(1, segScores.length);
      const activeInc = incidentDefs.filter(inc => isIncidentActive(inc, idx)).length;

      // Convert avg score -> percent congestion-ish
      // avg=1 => 18%, avg=2 => 52%, avg=3 => 86% (rough demo)
      const congPct = Math.round(18 + (avg-1) * 34);
      const flowIdx = Math.max(0, Math.min(100, Math.round(100 - congPct + (activeInc * -2))));

      return { congPct, flowIdx, activeInc };
    }

    // Build historical series for chart
    const hist = timeline.map((_, i)=> computeKPI(i));

    function drawMiniChart(currentIndex){
      const canvas = document.getElementById("miniChart");
      const ctx = canvas.getContext("2d");
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);

      // Background grid
      ctx.globalAlpha = 1;
      ctx.fillStyle = "rgba(255,255,255,0.00)";
      ctx.fillRect(0,0,W,H);
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 1;

      const pad = 26;
      const innerW = W - pad*2;
      const innerH = H - pad*2;

      // grid lines
      for(let i=0;i<=4;i++){
        const y = pad + (innerH*i/4);
        ctx.beginPath();
        ctx.moveTo(pad, y);
        ctx.lineTo(pad+innerW, y);
        ctx.stroke();
      }

      // series helpers
      const N = hist.length;
      const xAt = (i)=> pad + (innerW * (i/(N-1)));
      const yCong = (v)=> pad + innerH * (1 - (v/100));     // 0..100
      const yFlow = (v)=> pad + innerH * (1 - (v/100));     // 0..100
      const yInc  = (v)=> {
        // map 0..maxInc to 0..100 scale visually
        const maxInc = Math.max(...hist.map(h=>h.activeInc), 1);
        const pct = Math.min(100, Math.round((v/maxInc)*100));
        return yFlow(pct);
      };

      function drawLine(getY, stroke){
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 2.2;
        ctx.beginPath();
        for(let i=0;i<N;i++){
          const x = xAt(i);
          const y = getY(hist[i]);
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        }
        ctx.stroke();
      }

      // 3 lines: Congesti√≥n, Fluidez, Incidentes
      drawLine(h=> yCong(h.congPct), "rgba(251,113,133,0.95)"); // red-ish
      drawLine(h=> yFlow(h.flowIdx), "rgba(52,211,153,0.92)");  // green-ish
      drawLine(h=> yInc(h.activeInc), "rgba(251,191,36,0.92)"); // amber-ish

      // Legend
      ctx.fillStyle = "rgba(255,255,255,0.80)";
      ctx.font = "700 14px ui-sans-serif, system-ui";
      ctx.fillText("KPI hist√≥rico (demo)", pad, 20);

      ctx.font = "600 12px ui-sans-serif, system-ui";
      ctx.fillStyle = "rgba(251,113,133,0.95)";
      ctx.fillText("Congesti√≥n", pad, H-10);
      ctx.fillStyle = "rgba(52,211,153,0.92)";
      ctx.fillText("Fluidez", pad+110, H-10);
      ctx.fillStyle = "rgba(251,191,36,0.92)";
      ctx.fillText("Incidentes", pad+190, H-10);

      // Current cursor
      const cx = xAt(currentIndex);
      ctx.strokeStyle = "rgba(103,232,249,0.55)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(cx, pad);
      ctx.lineTo(cx, pad+innerH);
      ctx.stroke();

      // Current markers
      function dot(x,y,fill){
        ctx.fillStyle = fill;
        ctx.beginPath();
        ctx.arc(x,y,6,0,Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = "rgba(7,10,20,0.75)";
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      dot(cx, yCong(hist[currentIndex].congPct), "rgba(251,113,133,0.95)");
      dot(cx, yFlow(hist[currentIndex].flowIdx), "rgba(52,211,153,0.92)");
      dot(cx, yInc(hist[currentIndex].activeInc), "rgba(251,191,36,0.92)");
    }

    function updateKPICards(){
      const { congPct, flowIdx, activeInc } = computeKPI(tIndex);

      kpiCong.textContent = `${congPct}%`;
      kpiCongSub.textContent = congPct > 70 ? "Alta congesti√≥n (priorizar desv√≠os)" : (congPct > 40 ? "Congesti√≥n moderada" : "Tr√°fico relativamente fluido");

      kpiInc.textContent = String(activeInc);
      kpiIncSub.textContent = activeInc > 4 ? "Alta carga operativa" : (activeInc > 2 ? "Carga media" : "Baja carga operativa");

      kpiFlow.textContent = `${flowIdx}/100`;
      kpiFlowSub.textContent = flowIdx > 65 ? "Capacidad estable" : (flowIdx > 45 ? "Atenci√≥n: cuellos de botella" : "Riesgo de colapso local");

      // ETA set by corridor mode
      if(!corridorState.on){
        kpiEta.textContent = "‚Äî";
        kpiEtaSub.textContent = "Activar ‚ÄúCorredor Hospitalario‚Äù";
      }else{
        kpiEta.textContent = corridorState.etaText || "‚Äî";
        kpiEtaSub.textContent = "Simulaci√≥n con onda verde (demo)";
      }

      drawMiniChart(tIndex);
    }

    // ====== Corredor Hospitalario (Waouh+) ======
    const btnCorridor = document.getElementById("btnCorridor");
    const emgDist = document.getElementById("emgDist");
    const emgEta = document.getElementById("emgEta");
    const emgMode = document.getElementById("emgMode");

    const corridorState = {
      on: false,
      route: null,
      poly: null,
      marker: null,
      pulse: null,
      anim: null,
      progress: 0,
      etaText: null
    };

    function metersToKm(m){ return (m/1000).toFixed(1); }
    function secToMin(s){ return Math.max(1, Math.round(s/60)); }

    function estimateEmergencyETA(baseDurationS){
      // Demo model: improves with "onda verde" depending on congestion score
      const { congPct } = computeKPI(tIndex);
      const factor = 0.78 - (Math.min(80, congPct)/100)*0.10; // 0.70..0.78
      const improved = Math.max(60, baseDurationS * factor);
      return improved;
    }

    function interpLatLng(latlngs, t){
      // t in [0,1]
      if(!latlngs || latlngs.length < 2) return null;
      const idx = Math.floor(t * (latlngs.length - 1));
      const next = Math.min(latlngs.length - 1, idx + 1);
      const frac = (t * (latlngs.length - 1)) - idx;
      const a = latlngs[idx], b = latlngs[next];
      return [a[0] + (b[0]-a[0])*frac, a[1] + (b[1]-a[1])*frac];
    }

    function startPulse(latlng){
      stopPulse();
      corridorState.pulse = L.circle(latlng, {
        radius: 80,
        color: "rgba(103,232,249,0.95)",
        weight: 2,
        fillColor: "rgba(103,232,249,0.22)",
        fillOpacity: 0.22
      }).addTo(corridorLayer);

      let r = 80;
      let dir = 1;
      corridorState.anim = setInterval(()=>{
        if(!corridorState.pulse) return;
        r += dir * 18;
        if(r > 180) dir = -1;
        if(r < 80) dir = 1;
        corridorState.pulse.setRadius(r);
      }, 70);
    }

    function stopPulse(){
      if(corridorState.anim){ clearInterval(corridorState.anim); corridorState.anim = null; }
      if(corridorState.pulse){ corridorLayer.removeLayer(corridorState.pulse); corridorState.pulse = null; }
    }

    function stopCorridor(){
      corridorState.on = false;
      corridorState.route = null;
      corridorState.progress = 0;
      corridorState.etaText = null;

      if(corridorState.poly){ corridorLayer.removeLayer(corridorState.poly); corridorState.poly = null; }
      if(corridorState.marker){ corridorLayer.removeLayer(corridorState.marker); corridorState.marker = null; }
      stopPulse();
      if(corridorState.anim){ clearInterval(corridorState.anim); corridorState.anim = null; }

      btnCorridor.textContent = "Activar";
      emgMode.textContent = "OFF";
      emgDist.textContent = "‚Äî";
      emgEta.textContent = "‚Äî";
      updateKPICards();
    }

    async function startCorridor(){
      btnCorridor.textContent = "Cargando‚Ä¶";
      emgMode.textContent = "ON";
      corridorState.on = true;

      try{
        corridorLayer.clearLayers();
        const r = await routeOSRM(EMG.from, EMG.to);
        corridorState.route = r;

        const distKm = metersToKm(r.distance_m);
        const baseMin = secToMin(r.duration_s);
        const emgS = estimateEmergencyETA(r.duration_s);
        const emgMin = secToMin(emgS);

        emgDist.textContent = `${distKm} km`;
        emgEta.textContent = `${emgMin} min (vs ${baseMin} min)`;
        corridorState.etaText = `${emgMin} min`;

        // Corridor line (glow effect: two polylines)
        const glow = L.polyline(r.latlngs, { color:"rgba(103,232,249,0.35)", weight: 12, opacity:0.45, lineCap:"round" });
        const core = L.polyline(r.latlngs, { color:"rgba(103,232,249,0.95)", weight: 6, opacity:0.95, lineCap:"round" });
        corridorState.poly = L.layerGroup([glow, core]).addTo(corridorLayer);

        // Start marker at beginning + pulse
        const start = r.latlngs[0];
        corridorState.marker = L.circleMarker(start, {
          radius: 9, color:"rgba(103,232,249,0.95)", fillColor:"rgba(103,232,249,0.95)", fillOpacity:0.95, weight:3
        }).bindPopup(`<b>Corredor Hospitalario (demo)</b><br/>Onda verde activada<br/><span class="mono">ETA:</span> ${emgMin} min`).addTo(corridorLayer);

        startPulse(start);

        // Fit bounds
        const bounds = L.latLngBounds(r.latlngs.map(p=>L.latLng(p[0],p[1])));
        map.fitBounds(bounds.pad(0.18));

        // Animate along route
        if(corridorState.anim) clearInterval(corridorState.anim);
        corridorState.progress = 0;
        corridorState.anim = setInterval(()=>{
          if(!corridorState.on || !corridorState.route) return;
          corridorState.progress += 0.0048; // speed
          if(corridorState.progress >= 1){
            corridorState.progress = 1;
            const end = r.latlngs[r.latlngs.length - 1];
            corridorState.marker.setLatLng(end);
            stopPulse();
            startPulse(end);
            corridorState.marker.openPopup();
            // loop softly
            corridorState.progress = 0;
          }else{
            const pos = interpLatLng(r.latlngs, corridorState.progress);
            if(pos){
              corridorState.marker.setLatLng(pos);
              if(corridorState.pulse) corridorState.pulse.setLatLng(pos);
            }
          }
        }, 45);

        btnCorridor.textContent = "Desactivar";
        updateKPICards();
      }catch(e){
        emgMode.textContent = "ERROR";
        btnCorridor.textContent = "Reintentar";
        corridorState.on = false;
        corridorState.route = null;
        corridorState.etaText = null;
        updateKPICards();
        alert("No se pudo calcular el corredor (OSRM). Manteniendo modo demo sin corredor.");
      }
    }

    btnCorridor.addEventListener("click", ()=>{
      if(corridorState.on) stopCorridor();
      else startCorridor();
    });

    // ====== Timeline controls ======
    const btnPlay = document.getElementById("btnPlay");
    const btnStepBack = document.getElementById("btnStepBack");
    const btnStepFwd = document.getElementById("btnStepFwd");

    let playing = false;
    let timer = null;
    const FPS_MS = 650;

    function setIndex(i){
      tIndex = Math.max(0, Math.min(timeline.length - 1, i));
      tSlider.value = String(tIndex);
      updateTimelineLabel();
      updateTrafficStyles();
      renderIncidentMarkers();
      renderIncidentList();

      // If corridor is on, recompute ETA display (demo)
      if(corridorState.on && corridorState.route){
        const baseMin = secToMin(corridorState.route.duration_s);
        const emgS = estimateEmergencyETA(corridorState.route.duration_s);
        const emgMin = secToMin(emgS);
        emgEta.textContent = `${emgMin} min (vs ${baseMin} min)`;
        corridorState.etaText = `${emgMin} min`;
      }

      updateKPICards();
    }

    function play(){
      if(playing) return;
      playing = true;
      btnPlay.textContent = "‚è∏ Pausar";
      timer = setInterval(()=>{
        if(tIndex >= timeline.length - 1) setIndex(0);
        else setIndex(tIndex + 1);
      }, FPS_MS);
    }
    function pause(){
      playing = false;
      btnPlay.textContent = "‚ñ∂ Reproducir";
      if(timer) clearInterval(timer);
      timer = null;
    }
    btnPlay.addEventListener("click", ()=> playing ? pause() : play());
    btnStepBack.addEventListener("click", ()=> { pause(); setIndex(tIndex - 1); });
    btnStepFwd.addEventListener("click", ()=> { pause(); setIndex(tIndex + 1); });
    tSlider.addEventListener("input", (e)=>{ pause(); setIndex(parseInt(e.target.value,10)); });

    // ====== Init ======
    updateTimelineLabel();
    document.getElementById("routeCount").textContent = String(segmentDefs.length);

    buildTrafficLayer()
      .then(()=>{
        renderIncidentMarkers();
        renderIncidentList();
        updateKPICards();
      })
      .catch(()=>{
        document.getElementById("snapStatus").textContent = "Error OSRM: usando fallback (l√≠neas simples).";
        renderIncidentMarkers();
        renderIncidentList();
        updateKPICards();
      });
  </script>
</body>
</html>
